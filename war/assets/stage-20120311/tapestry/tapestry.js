var Tapestry={FORM_VALIDATE_EVENT:"tapestry:formvalidate",FORM_PREPARE_FOR_SUBMIT_EVENT:"tapestry:formprepareforsubmit",FORM_PROCESS_SUBMIT_EVENT:"tapestry:formprocesssubmit",FIELD_VALIDATE_EVENT:"tapestry:fieldvalidate",FORM_VALIDATE_FIELDS_EVENT:"tapestry:validatefields",FOCUS_CHANGE_EVENT:"tapestry:focuschange",ZONE_UPDATED_EVENT:"tapestry:zoneupdated",CHANGE_VISIBILITY_EVENT:"tapestry:changevisibility",HIDE_AND_REMOVE_EVENT:"tapestry:hideandremove",TRIGGER_ZONE_UPDATE_EVENT:"tapestry:triggerzoneupdate",ACTION_EVENT:"tapestry:action",DEBUG_ENABLED:false,CONSOLE_DURATION:10,PREVENT_SUBMISSION:"t-prevent-submission",pageLoaded:false,waitForPage:function(d){if(Tapestry.pageLoaded){return true}Event.extend(d||window.event).stop();var b=$(document.body);var c=new Element("div",{"class":"t-dialog-overlay"});c.setOpacity(0);b.insert({top:c});new Effect.Appear(c,{duration:0.2,from:0});var a=new Element("div",{"class":"t-page-loading-banner"}).update(Tapestry.Messages.pageIsLoading);c.insert({top:a});var e=function(){new Effect.Fade(c,{duration:0.2,afterFinish:function(){Tapestry.remove(c)}})};document.observe("dom:loaded",e);if(Tapestry.pageLoaded){e.call(null);return true}else{return false}},onDOMLoaded:function(a){document.observe("dom:loaded",a)},onDomLoadedCallback:function(){Tapestry.pageLoaded=true;Tapestry.ScriptManager.initialize();$$(".t-invisible").each(function(a){a.hide();a.removeClassName("t-invisible")});$$("INPUT","SELECT","TEXTAREA").each(function(b){var a=$T(b);if(!a.observingFocusChange){b.observe("focus",function(){if(b!=Tapestry.currentFocusField){document.fire(Tapestry.FOCUS_CHANGE_EVENT,b);Tapestry.currentFocusField=b}});a.observingFocusChange=true}});$$("INPUT[type=submit]","INPUT[type=image]").each(function(b){var a=$T(b);if(!a.trackingClicks){b.observe("click",function(){$(b.form).setSubmittingElement(b)});a.trackingClicks=true}})},init:function(a){$H(a).each(function(d){var b=d.key;var c=Tapestry.Initializer[b];if(c==undefined){Tapestry.error(Tapestry.Messages.missingInitializer,{name:b});return}d.value.each(function(e){if(!Object.isArray(e)){e=[e]}c.apply(this,e)})})},error:function(b,a){Tapestry.invokeLogger(b,a,Tapestry.Logging.error)},warn:function(b,a){Tapestry.invokeLogger(b,a,Tapestry.Logging.warn)},info:function(b,a){Tapestry.invokeLogger(b,a,Tapestry.Logging.info)},debug:function(b,a){if(Tapestry.DEBUG_ENABLED){Tapestry.invokeLogger(b,a,Tapestry.Logging.debug)}},invokeLogger:function(c,b,a){if(b!=undefined){c=c.interpolate(b)}a.call(this,c)},loadScriptsInReply:function(a,c){var b=a.redirectURL;if(b){window.location.href=b;return}Tapestry.ScriptManager.addStylesheets(a.stylesheets);Tapestry.ScriptManager.addScripts(a.scripts,function(){c.call(this);Tapestry.executeInits(a.inits)})},executeInits:function(a){$A(a).each(function(b){Tapestry.init(b)});Tapestry.onDomLoadedCallback()},ajaxExceptionHandler:function(a,b){Tapestry.error(Tapestry.Messages.communicationFailed+b);Tapestry.debug(Tapestry.Messages.ajaxFailure+b,a);throw b},ajaxFailureHandler:function(b){var d=b.getHeader("X-Tapestry-ErrorMessage");var c=unescape(d).escapeHTML();Tapestry.error(Tapestry.Messages.communicationFailed+c);Tapestry.debug(Tapestry.Messages.ajaxFailure+c,b);var e=b.getResponseHeader("content-type");var a=e&&(e.split(";")[0]==="text/html");if(a){T5.ajax.showExceptionDialog(b.responseText)}},ajaxRequest:function(c,b){if(Object.isFunction(b)){return Tapestry.ajaxRequest(c,{onSuccess:b})}var a=(b&&b.onSuccess)||Prototype.emptyFunction;var e=$H({onException:Tapestry.ajaxExceptionHandler,onFailure:Tapestry.ajaxFailureHandler}).update(b).update({onSuccess:function(f,g){if(Tapestry.windowUnloaded&&f.responseText.blank()){return}if(!f.getStatus()||!f.request.success()){e.get("onFailure").call(this,f);return}try{a.call(this,f,g)}catch(h){e.get("onException").call(this,f)}}});var d=new Ajax.Request(c,e.toObject());return d},findZoneManager:function(b){var a=$T(b).zoneId;return Tapestry.findZoneManagerForZone(a)},findZoneManagerForZone:function(a){var c=$(a);if(!c){Tapestry.error(Tapestry.Messages.missingZone,{id:a});return null}var b=$T(c).zoneManager;if(!b){Tapestry.error(Tapestry.Messages.noZoneManager,c);return null}return b},rebuildURL:function(b){if(b.match(/^https?:/)){return b}if(!b.startsWith("/")){Tapestry.error(Tapestry.Messages.pathDoesNotStartWithSlash,{path:b});return b}if(!Tapestry.buildUrl){var a=window.location;Tapestry.buildUrl=a.protocol+"//"+a.host}return Tapestry.buildUrl+b},stripToLastSlash:function(a){var b=a.lastIndexOf("/");return a.substring(0,b+1)},formatLocalizedNumber:function(e,f){var d=Tapestry.decimalFormatSymbols.minusSign;var c=Tapestry.decimalFormatSymbols.groupingSeparator;var b=Tapestry.decimalFormatSymbols.decimalSeparator;var a="";e.strip().toArray().each(function(g){if(g==d){a+="-";return}if(g==c){return}if(g==b){if(f){throw Tapestry.Messages.notAnInteger}g="."}else{if(g<"0"||g>"9"){throw Tapestry.Messages.invalidCharacter}}a+=g});return Number(a)},replaceElementTagName:function(c,f){c=$(c);var a=c.tagName;var d=document.createElement("html");d.appendChild(c.cloneNode(true));var e=d.innerHTML;var b=e.replace(new RegExp("^<"+a,"i"),"<"+f).replace(new RegExp("</"+a+">$","i"),"</"+f+">");c.insert({before:b});T5.dom.remove(c)},remove:T5.dom.remove,purgeChildren:T5.dom.purgeChildren};Element.addMethods({isDeepVisible:function(c,b){var d=$(c);var a=(b&&b.bound)||function(e){return e.tagName=="FORM"};while(true){if(!d.visible()){return false}if(a(d)){break}d=$(d.parentNode)}return true},observeAction:function(b,a,c){b.observe(a,function(d){d.stop();b.fire(Tapestry.ACTION_EVENT,d)});b.observe(Tapestry.ACTION_EVENT,c);$T(b).hasAction=true}});Element.addMethods("FORM",{getFormEventManager:function(b){b=$(b);var a=$T(b).formEventManager;if(a==undefined){throw"No Tapestry.FormEventManager object has been created for form '#{id}'.".interpolate(b)}return a},setSubmittingElement:function(b,a){b.getFormEventManager().setSubmittingElement(a)},skipValidation:function(a){$T(a).skipValidation=true},performSubmit:function(b,a){if(b.onsubmit==undefined||b.onsubmit.call(window.document,a)){b.submit()}},sendAjaxRequest:function(c,b,a){c=$(c);a=Object.clone(a||{});var d=c.getElements().reject(function(f){return f.tagName=="INPUT"&&f.type=="submit"});var e=Form.serializeElements(d,true);Object.extend(e,a.parameters);a.parameters=e;return Tapestry.ajaxRequest(b,a)}});Element.addMethods(["INPUT","SELECT","TEXTAREA"],{getFieldEventManager:function(c){c=$(c);var b=$T(c);var a=b.fieldEventManager;if(a==undefined){a=new Tapestry.FieldEventManager(c);b.fieldEventManager=a}return a},showValidationMessage:function(a,b){a=$(a);a.getFieldEventManager().showValidationMessage(b);return a},removeDecorations:function(a){$(a).getFieldEventManager().removeDecorations();return a},addValidator:function(b,a){b.observe(Tapestry.FIELD_VALIDATE_EVENT,function(d){try{a.call(this,d.memo.translated)}catch(c){b.showValidationMessage(c)}});return b}});Tapestry.Initializer=T5.initializers;T5.extendInitializers({activate:function(a){$(a).activate()},evalScript:eval,ajaxFormLoop:function(a){var b=$(a.rowInjector);$(a.addRowTriggers).each(function(c){$(c).observeAction("click",function(d){$(b).trigger()})})},formLoopRemoveLink:function(a){var b=$(a.link);var c=a.fragment;b.observeAction("click",function(e){var d=function(h){var f=$(c);var g=Tapestry.ElementEffect.fade(f);g.options.afterFinish=function(){Tapestry.remove(f)}};Tapestry.ajaxRequest(a.url,d)})},linkZone:function(a){Tapestry.Initializer.updateZoneOnEvent("click",a.linkId,a.zoneId,a.url)},linkSelectToZone:function(a){Tapestry.Initializer.updateZoneOnEvent("change",a.selectId,a.zoneId,a.url)},linkSubmit:function(a){Tapestry.replaceElementTagName(a.clientId,"A");$(a.clientId).writeAttribute("href","#");if(a.cancel){$(a.clientId).writeAttribute("name","cancel")}$(a.clientId).observeAction("click",function(c){var b=$(a.form);if(!a.validate){b.skipValidation()}b.setSubmittingElement(this);b.performSubmit(c)})},updateZoneOnEvent:function(c,e,b,d){e=$(e);$T(e).zoneUpdater=true;var a=b=="^"?$(e).up(".t-zone"):$(b);if(!a){Tapestry.error("Could not find zone element '#{zoneId}' to update on #{eventName} of element '#{elementId}'.",{zoneId:b,eventName:c,elementId:e.id});return}$T(e).zoneId=a.id;if(e.tagName=="FORM"){e.addClassName(Tapestry.PREVENT_SUBMISSION);e.observe(Tapestry.FORM_PROCESS_SUBMIT_EVENT,function(){var f=Tapestry.findZoneManager(e);if(!f){return}var g=function(h){f.processReply(h.responseJSON)};e.sendAjaxRequest(d,{parameters:{"t:zoneid":b},onSuccess:g})});return}e.observeAction(c,function(f){e.fire(Tapestry.TRIGGER_ZONE_UPDATE_EVENT)});e.observe(Tapestry.TRIGGER_ZONE_UPDATE_EVENT,function(){var f=Tapestry.findZoneManager(e);if(!f){return}var g={};if(e.tagName=="SELECT"&&e.value){g["t:selectvalue"]=e.value}f.updateFromURL(d,g)})},formEventManager:function(a){$T(a.formId).formEventManager=new Tapestry.FormEventManager(a)},validate:function(a){$H(a).each(function(c){var b=$(c.key);$(b).getFieldEventManager();$A(c.value).each(function(d){var e=d[0];var f=d[1];var g=d[2];var h=Tapestry.Validator[e];if(h==undefined){Tapestry.error(Tapestry.Messages.missingValidator,{name:e,fieldName:b.id});return}h.call(this,b,f,g)})})},zone:function(a){new Tapestry.ZoneManager(a)},formInjector:function(a){new Tapestry.FormInjector(a)},cancelButton:function(a){$(a).observeAction("click",function(b){$(this.form).skipValidation();$(this.form).setSubmittingElement(a);$(this.form).performSubmit(b)})}});Tapestry.Validator={required:function(b,a){$(b).getFieldEventManager().requiredCheck=function(c){if((T5._.isString(c)&&c.strip()=="")||c==null){$(b).showValidationMessage(a)}}},numericformat:function(c,a,b){$(c).getFieldEventManager().translator=function(d){try{return Tapestry.formatLocalizedNumber(d,b)}catch(f){$(c).showValidationMessage(a)}}},minlength:function(c,b,a){c.addValidator(function(d){if(d.length<a){throw b}})},maxlength:function(c,b,a){c.addValidator(function(d){if(d.length>a){throw b}})},min:function(c,a,b){c.addValidator(function(d){if(d<b){throw a}})},max:function(c,a,b){c.addValidator(function(d){if(d>b){throw a}})},regexp:function(d,a,c){var b=new RegExp(c);d.addValidator(function(e){if(!b.test(e)){throw a}})}};Tapestry.ErrorPopup=Class.create({BUBBLE_VERT_OFFSET:-34,BUBBLE_HORIZONTAL_OFFSET:-20,BUBBLE_WIDTH:"auto",BUBBLE_HEIGHT:"39px",IE_FADE_TIME:500,initialize:function(a){this.field=$(a);this.outerDiv=null},createUI:function(){this.innerSpan=new Element("span");this.outerDiv=$(new Element("div",{id:this.field.id+"_errorpopup","class":"t-error-popup"})).update(this.innerSpan).hide();var a=$(document.body);a.insert({bottom:this.outerDiv});this.outerDiv.absolutize();this.outerDiv.observe("click",function(b){this.ignoreNextFocus=true;this.stopAnimation();this.outerDiv.hide();this.field.activate();b.stop()}.bindAsEventListener(this));this.queue={position:"end",scope:this.field.id};Event.observe(window,"resize",this.repositionBubble.bind(this));document.observe(Tapestry.FOCUS_CHANGE_EVENT,function(b){if(this.ignoreNextFocus){this.ignoreNextFocus=false;return}if(b.memo==this.field){this.fadeIn();return}this.fadeOut()}.bind(this))},showMessage:function(a){if(this.outerDiv==null){this.createUI()}this.stopAnimation();this.innerSpan.update(a);this.hasMessage=true;this.fadeIn()},repositionBubble:function(){var a=this.field.cumulativeOffset();this.outerDiv.setStyle({top:(a[1]+this.BUBBLE_VERT_OFFSET)+"px",left:(a[0]+this.BUBBLE_HORIZONTAL_OFFSET)+"px",width:this.BUBBLE_WIDTH,height:this.BUBBLE_HEIGHT})},fadeIn:function(){if(!this.hasMessage){return}this.repositionBubble();if(this.animation){return}if(Prototype.Browser.IE){var a=T5._;this.outerDiv.show();var b=a.bind(this.hideIfNotFocused,this);a.delay(b,this.IE_FADE_TIME);return}this.animation=new Effect.Appear(this.outerDiv,{queue:this.queue,afterFinish:function(){this.animation=null;if(this.field!=Tapestry.currentFocusField){this.fadeOut()}}.bind(this)})},hideIfNotFocused:function(){if(this.outerDiv!=null&&this.field!=Tapestry.currentFocusField){this.outerDiv.hide()}},stopAnimation:function(){if(this.animation){this.animation.cancel()}this.animation=null},fadeOut:function(){if(this.animation||this.outerDiv==null){return}if(Prototype.Browser.IE){var a=this.outerDiv;T5._.delay(function(){a.hide()},this.IE_FADE_TIME);return}this.animation=new Effect.Fade(this.outerDiv,{queue:this.queue,afterFinish:function(){this.animation=null}.bind(this)})},hide:function(){this.hasMessage=false;this.stopAnimation();this.outerDiv&&this.outerDiv.hide()}});Tapestry.FormEventManager=Class.create({initialize:function(a){this.form=$(a.formId);this.validateOnBlur=a.validate.blur;this.validateOnSubmit=a.validate.submit;this.form.onsubmit=this.handleSubmit.bindAsEventListener(this)},setSubmittingElement:function(b){if(!this.submitHidden){if(this.form.getInputs("hidden","t:formdata").size()==0){return}var a=this.form.getInputs("hidden","t:submit");if(a.size()==0){var c=this.form.getInputs("hidden").first();this.submitHidden=new Element("input",{type:"hidden",name:"t:submit"});c.insert({after:this.submitHidden})}else{this.submitHidden=a.first()}}this.submitHidden.value=b==null?null:Object.toJSON([$(b).id,$(b).name])},handleSubmit:function(b){Event.extend(b);var a=$T(this.form);a.validationError=false;if(!a.skipValidation){a.skipValidation=false;this.form.fire(Tapestry.FORM_VALIDATE_FIELDS_EVENT,this.form);if(!a.validationError){this.form.fire(Tapestry.FORM_VALIDATE_EVENT,this.form)}if(a.validationError){b.stop();this.setSubmittingElement(null);return false}}this.form.fire(Tapestry.FORM_PREPARE_FOR_SUBMIT_EVENT,this.form);if(this.form.hasClassName(Tapestry.PREVENT_SUBMISSION)){b.stop();this.form.fire(Tapestry.FORM_PROCESS_SUBMIT_EVENT);return false}return true}});Tapestry.FieldEventManager=Class.create({initialize:function(b){this.field=$(b);this.translator=Prototype.K;var a=$(this.field.form).getFormEventManager();if(a.validateOnBlur){document.observe(Tapestry.FOCUS_CHANGE_EVENT,function(c){if(Tapestry.currentFocusField==this.field&&this.field.form==c.memo.form){this.validateInput()}}.bindAsEventListener(this))}if(a.validateOnSubmit){$(this.field.form).observe(Tapestry.FORM_VALIDATE_FIELDS_EVENT,this.validateInput.bindAsEventListener(this))}},getLabel:function(){if(!this.label){var a="label[for='"+this.field.id+"']";this.label=this.field.form.down(a)}return this.label},getIcon:function(){if(!this.icon){this.icon=$(this.field.id+"_icon")}return this.icon},removeDecorations:function(){this.field.removeClassName("t-error");this.getLabel()&&this.getLabel().removeClassName("t-error");this.getIcon()&&this.getIcon().hide();if(this.errorPopup){this.errorPopup.hide()}},showValidationMessage:function(b){$T(this.field).validationError=true;$T(this.field.form).validationError=true;this.field.addClassName("t-error");this.getLabel()&&this.getLabel().addClassName("t-error");var a=this.getIcon();if(a&&!a.visible()){new Effect.Appear(this.icon)}if(this.errorPopup==undefined){this.errorPopup=new Tapestry.ErrorPopup(this.field)}this.errorPopup.showMessage(b)},validateInput:function(){if(this.field.disabled){return false}if(!this.field.isDeepVisible()){return false}var a=$T(this.field);var b=$F(this.field);a.validationError=false;if(this.requiredCheck){this.requiredCheck.call(this,b)}if(!a.validationError&&!(T5._.isString(b)&&b.blank())){var c=this.translator(b);if(!a.validationError){this.field.fire(Tapestry.FIELD_VALIDATE_EVENT,{value:b,translated:c})}}if(!a.validationError){this.field.removeDecorations()}return a.validationError}});Tapestry.ElementEffect={show:function(a){return new Effect.Appear(a)},highlight:function(b,a){if(a){return new Effect.Highlight(b,{endcolor:a,restorecolor:a})}return new Effect.Highlight(b)},slidedown:function(a){return new Effect.SlideDown(a)},slideup:function(a){return new Effect.SlideUp(a)},fade:function(a){return new Effect.Fade(a)},none:function(a){return a}};Tapestry.ZoneManager=Class.create({initialize:function(a){this.element=$(a.element);this.showFunc=Tapestry.ElementEffect[a.show]||Tapestry.ElementEffect.show;this.updateFunc=Tapestry.ElementEffect[a.update]||Tapestry.ElementEffect.highlight;this.specParameters=a.parameters;this.endcolor=this.element.getStyle("background-color").parseColor("#ffffff");$T(this.element).zoneManager=this;var b=this.element.select(".t-zone-update");this.updateElement=b.first()||this.element},show:function(b){Tapestry.purgeChildren(this.updateElement);this.updateElement.update(b);var a=this.element.visible()?this.updateFunc:this.showFunc;a.call(this,this.element,this.endcolor);this.element.fire(Tapestry.ZONE_UPDATED_EVENT)},processReply:function(a){Tapestry.loadScriptsInReply(a,function(){a.content!=undefined&&this.show(a.content);a.zones&&Object.keys(a.zones).each(function(b){var d=Tapestry.findZoneManagerForZone(b);if(d){var c=a.zones[b];d.show(c)}})}.bind(this))},updateFromURL:function(a,c){var b=$H({"t:zoneid":this.element.id}).update(this.specParameters);if(!Object.isUndefined(c)){b.update(c)}Tapestry.ajaxRequest(a,{parameters:b.toObject(),onSuccess:function(d){this.processReply(d.responseJSON)}.bind(this)})}});Tapestry.FormInjector=Class.create({initialize:function(a){this.element=$(a.element);this.url=a.url;this.below=a.below;this.showFunc=Tapestry.ElementEffect[a.show]||Tapestry.ElementEffect.highlight;this.element.trigger=function(){var b=function(f){var c=f.responseJSON;var e=new Element(this.element.tagName,{"class":this.element.className});var d={};d[this.below?"after":"before"]=e;Tapestry.loadScriptsInReply(c,function(){this.element.insert(d);e.update(c.content);e.id=c.elementId;this.showFunc(e)}.bind(this))}.bind(this);Tapestry.ajaxRequest(this.url,b);return false}.bind(this)}});Tapestry.ScriptManager={initialize:function(){this.emulated=false;if(!document.scripts){this.emulated=true;document.scripts=new Array();$$("script").each(function(a){document.scripts.push(a)})}},loadScript:function(d,c){var b=new Element("script",{src:d,type:"text/javascript"});$$("head").first().insert({bottom:b});if(this.emulated){document.scripts.push(b)}if(Prototype.Browser.IE){var a=false;b.onreadystatechange=function(){if(!a&&this.readyState=="loaded"||this.readyState=="complete"){a=true;c.call(this)}};return}b.onload=c.bindAsEventListener(this)},rebuildURLIfIE:Prototype.Browser.IE?Tapestry.rebuildURL:T5._.identity,addScripts:function(a,f){var d=T5._;var c=d(document.scripts).chain().pluck("src").without("").map(this.rebuildURLIfIE).value();var b=this;var e=d(a).chain().map(Tapestry.rebuildURL).difference(c).reverse().reduce(function(g,h){return function(){b.loadScript(h,g)}},f).value();e.call(this)},addStylesheets:function(f){if(!f){return}var b=T5._;var a=b(document.styleSheets).chain().pluck("href").without("").map(this.rebuildURLIfIE).value();var e=b(f).chain().map(function(g){g.href=Tapestry.rebuildURL(g.href);return g}).reject(function(g){return b(a).contains(g.href)}).value();var d=$$("head").first();var c=d.down("link[rel='stylesheet t-ajax-insertion-point']");b(e).each(function(h){var g=new Element("link",{type:"text/css",rel:"stylesheet",href:h.href});if(h.media){g.writeAttribute("media",h.media)}if(c){c.insert({before:g})}else{d.insert({bottom:g})}})}};function $T(a){return $(a).getStorage()}Tapestry.onDOMLoaded(Tapestry.onDomLoadedCallback);Event.observe(window,"beforeunload",function(){Tapestry.windowUnloaded=true});