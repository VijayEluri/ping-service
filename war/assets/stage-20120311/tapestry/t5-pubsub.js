T5.define("pubsub",function(){var i=T5._;var a=[];var j=[];function g(k){return T5.$(k)}function h(k){i.each(j,function(l){if(l.topic===k){l.listeners=undefined}})}function d(m,n){var l=i.select(a,function(p){return p.topic===m});var o=i.select(l,function(p){return p.element===n});var k=i.select(l,function(p){return !p.element});return i(o).chain().union(k).pluck("listenerfn").value()}function e(k,l,n){var m={topic:k,element:g(l),listenerfn:n};a.push(m);h(m.topic);k=null;l=null;n=null;return function(){a=i.without(a,m);h(m.topic)}}function f(k,l){l=g(l);if(l==null){throw"Element may not be null when creating a publisher."}var n=i.detect(j,function(o){return o.topic===k&&o.element===l});if(n){return n.publisherfn}var m={topic:k,element:l,publisherfn:function(r){if(m.listeners==undefined){m.listeners=d(m.topic,m.element)}var p=false;var s={element:m.element,cancel:function(){p=true}};var o=[];for(var q=0;q<m.listeners.length;q++){var t=m.listeners[q];o.push(t(r,s));if(p){break}}return o}};j.push(m);l.t5pubsub=true;k=null;l=null;return m.publisherfn}function c(k,l,m){return f(k,l)(m)}function b(k){a=i.reject(a,function(l){return l.element===k});j=i.reject(j,function(m){var l=m.element===k;if(l){m.listeners=undefined;m.element=undefined}return l})}return{createPublisher:f,subscribe:e,publish:c,cleanupRemovedElement:b}});T5.extend(T5,{pub:T5.pubsub.publish,sub:T5.pubsub.subscribe});